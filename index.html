<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Coaching Manager Pro - Phone Support</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020617; --card: #0f172a; --accent: #38bdf8;
            --present: #10b981; --absent: #ef4444; --text: #f1f5f9;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Hind Siliguri', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 15px; padding-bottom: 100px; }
        .card { background: var(--card); padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #1e293b; }
        h2, h3 { color: var(--accent); margin-bottom: 15px; text-align: center; }
        
        select, input, textarea { 
            width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 12px; 
            border: 1px solid #334155; background: #1e293b; color: white; outline: none;
        }
        .btn { padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; width: 100%; margin-top: 5px; }
        .btn-primary { background: var(--accent); color: #020617; }
        .btn-sec { background: #334155; color: white; }
        .btn-danger { background: var(--absent); color: white; }
        .btn-call { background: #fbbf24; color: #000; padding: 5px 10px; border-radius: 8px; text-decoration: none; font-size: 0.8rem; display: none; margin-top: 5px; }

        .st-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; background: rgba(255,255,255,0.03); margin-bottom: 8px; border-radius: 15px;
        }
        .att-btns { display: flex; gap: 8px; align-items: center; }
        .btn-p, .btn-a { width: 45px; height: 45px; border-radius: 12px; border: 2px solid transparent; cursor: pointer; opacity: 0.2; font-size: 1.2rem; }
        .active-p { background: var(--present); opacity: 1; border-color: white; }
        .active-a { background: var(--absent); opacity: 1; border-color: white; }

        .nav { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; display: flex; gap: 10px; z-index: 1000; }
        .overlay { position: fixed; inset: 0; background: var(--bg); z-index: 100; padding: 20px; display: none; overflow-y: auto; }

        @media print {
            .no-print { display: none !important; }
            .overlay { display: block !important; position: static; color: black; background: white; }
            table { width: 100%; border-collapse: collapse; margin-top: 15px; }
            th, td { border: 1px solid #000; padding: 8px; text-align: center; font-size: 10px; }
        }
        table { width: 100%; border-collapse: collapse; color: white; margin-top: 10px; font-size: 13px; }
        th, td { border: 1px solid #334155; padding: 8px; text-align: center; }
        .csv-label { display: block; padding: 15px; background: #334155; border-radius: 12px; text-align: center; cursor: pointer; border: 2px dashed var(--accent); margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="home">
    <h2>üéØ Coaching Manager Pro</h2>
    <div class="card">
        <div style="display:flex; gap:10px;">
            <select id="runClass"></select>
            <select id="runBatch"></select>
        </div>
        <button class="btn btn-primary" onclick="loadAttendanceList()">üìã ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
    <div id="attListZone" style="display:none;">
        <h3 id="attTitle"></h3>
        <div id="stItems"></div>
        <button class="btn btn-primary" style="background:var(--present); color:white; margin-top:15px;" onclick="finalizeAttendance()">‚úÖ ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<div id="setOverlay" class="overlay">
    <h3>‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶ì ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ</h3>
    <div class="card">
        <h4>‡ßß. ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶ì ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶Ø‡ßã‡¶ó</h4>
        <div style="display:flex; gap:5px;"><input type="text" id="addCls" placeholder="Class (‡¶â‡¶¶‡¶æ: 10)"><button class="btn btn-sec" style="width:70px" onclick="addNew('classes', 'addCls')">‡¶Ø‡ßã‡¶ó</button></div>
        <div style="display:flex; gap:5px;"><input type="text" id="addBtc" placeholder="Batch (‡¶â‡¶¶‡¶æ: Morning)"><button class="btn btn-sec" style="width:70px" onclick="addNew('batches', 'addBtc')">‡¶Ø‡ßã‡¶ó</button></div>
    </div>
    <div class="card">
        <h4>‡ß®. CSV ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶á‡¶®‡¶™‡ßÅ‡¶ü (‡ß´ ‡¶ü‡¶ø ‡¶ï‡¶≤‡¶æ‡¶Æ)</h4>
        <label for="csvFile" class="csv-label">üìÇ CSV ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®<br><small>(Format: Name, Roll, Class, Batch, Phone)</small></label>
        <input type="file" id="csvFile" accept=".csv" style="display:none;" onchange="handleCSV(event)">
        <p id="csvStatus" style="font-size: 0.8rem; text-align: center; color: var(--accent);"></p>
    </div>
    <div id="stManagementList"></div>
    <button class="btn btn-sec" onclick="closeO('setOverlay')">‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
</div>

<div id="repOverlay" class="overlay">
    <div class="no-print">
        <h3>üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡¶∞</h3>
        <div class="card">
            <select id="rCls"></select><select id="rBtc"></select>
            <button class="btn btn-primary" onclick="createReport()">üìà ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
            <button class="btn btn-sec" onclick="window.print()">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü / PDF ‡¶∏‡ßá‡¶≠</button>
        </div>
    </div>
    <div id="printArea"></div>
    <button class="btn btn-sec no-print" onclick="closeO('repOverlay')">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<div class="nav no-print">
    <button class="btn btn-sec" onclick="openSettings()">‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
    <button class="btn btn-primary" onclick="location.reload()">üîÑ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂</button>
    <button class="btn btn-sec" onclick="openReports()">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('coaching_db_v9')) || {
        classes: ['Class 9', 'Class 10'],
        batches: ['Batch A', 'Batch B'],
        students: [],
        logs: []
    };
    let curSession = {};

    function sync() { localStorage.setItem('coaching_db_v9', JSON.stringify(db)); }

    function updateDropdowns() {
        const fill = (ids, items) => ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = items.map(i => `<option value="${i}">${i}</option>`).join('');
        });
        fill(['runClass', 'inCls', 'rCls'], db.classes);
        fill(['runBatch', 'inBtc', 'rBtc'], db.batches);
    }

    function addNew(key, id) {
        const val = document.getElementById(id).value.trim();
        if(val) { db[key].push(val); sync(); document.getElementById(id).value = ''; updateDropdowns(); }
    }

    function handleCSV(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const rows = e.target.result.split('\n');
            let count = 0;
            rows.forEach((row, index) => {
                if(index === 0 || !row.trim()) return;
                const [name, roll, cls, btc, phone] = row.split(',').map(item => item.trim());
                if(name && roll && cls && btc) {
                    db.students.push({ id: Date.now() + Math.random(), name, roll, cls, btc, phone: phone || '' });
                    if(!db.classes.includes(cls)) db.classes.push(cls);
                    if(!db.batches.includes(btc)) db.batches.push(btc);
                    count++;
                }
            });
            sync(); updateDropdowns();
            document.getElementById('csvStatus').innerText = `${count} ‡¶ú‡¶® ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!`;
            renderManager();
        };
        reader.readAsText(file);
    }

    function loadAttendanceList() {
        const cls = document.getElementById('runClass').value, btc = document.getElementById('runBatch').value;
        const list = db.students.filter(s => s.cls === cls && s.btc === btc).sort((a,b) => a.roll - b.roll);
        if(!list.length) return alert("‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á!");
        document.getElementById('attTitle').innerText = `${cls} | ${btc}`;
        document.getElementById('attListZone').style.display = 'block';
        curSession = {};
        document.getElementById('stItems').innerHTML = list.map(s => `
            <div class="st-row">
                <div>
                    <b>${s.name}</b><br>
                    <small>Roll: ${s.roll} | Mob: ${s.phone}</small>
                    <a id="call-${s.id}" href="tel:${s.phone}" class="btn-call">üìû Call Family</a>
                </div>
                <div class="att-btns">
                    <button id="p-${s.id}" class="btn-p" onclick="mark('${s.id}','P')">‚úÖ</button>
                    <button id="a-${s.id}" class="btn-a" onclick="mark('${s.id}','A')">‚ùå</button>
                </div>
            </div>
        `).join('');
    }

    function mark(id, s) {
        curSession[id] = s;
        document.getElementById(`p-${id}`).className = 'btn-p' + (s==='P'?' active-p':'');
        document.getElementById(`a-${id}`).className = 'btn-a' + (s==='A'?' active-a':'');
        // Show/Hide Call Button only if Absent
        const callBtn = document.getElementById(`call-${id}`);
        if(s === 'A' && callBtn.getAttribute('href') !== 'tel:') {
            callBtn.style.display = 'inline-block';
        } else {
            callBtn.style.display = 'none';
        }
    }

    function finalizeAttendance() {
        db.logs.push({ date: new Date().toLocaleDateString('en-GB'), cls: document.getElementById('runClass').value, btc: document.getElementById('runBatch').value, data: curSession });
        sync(); alert("‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®!"); location.reload();
    }

    function createReport() {
        const cls = document.getElementById('rCls').value, btc = document.getElementById('rBtc').value;
        const filteredLogs = db.logs.filter(l => l.cls === cls && l.btc === btc);
        const batchSt = db.students.filter(s => s.cls === cls && s.btc === btc).sort((a,b) => a.roll - b.roll);
        const dates = [...new Set(filteredLogs.map(l => l.date))];

        let h = `<h3>${cls} - ${btc} ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3><table><tr><th>‡¶∞‡ßã‡¶≤</th><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>`;
        dates.forEach(d => h += `<th>${d.split('/')[0]}</th>`);
        h += `<th>‡¶Æ‡ßã‡¶ü</th></tr>`;
        batchSt.forEach(s => {
            let count = 0; h += `<tr><td>${s.roll}</td><td>${s.name}</td><td>${s.phone}</td>`;
            dates.forEach(d => {
                const stat = filteredLogs.find(l => l.date === d)?.data[s.id] || '-';
                if(stat === 'P') count++; h += `<td>${stat}</td>`;
            });
            h += `<td>${count}</td></tr>`;
        });
        document.getElementById('printArea').innerHTML = h + `</table>`;
    }

    function renderManager() {
        document.getElementById('stManagementList').innerHTML = db.students.map(s => `
            <div class="st-row" style="font-size:0.8rem">
                <span><b>${s.roll}</b>. ${s.name} (${s.phone})</span>
                <button class="btn-danger" style="padding:5px 10px; border-radius:8px; border:none; width:auto;" onclick="delSt(${s.id})">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
            </div>
        `).join('') || "‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§";
    }

    function delSt(id) { if(confirm("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) { db.students = db.students.filter(s => s.id !== id); sync(); renderManager(); } }
    function openSettings() { document.getElementById('setOverlay').style.display='block'; updateDropdowns(); renderManager(); }
    function openReports() { document.getElementById('repOverlay').style.display='block'; updateDropdowns(); }
    function closeO(id) { document.getElementById(id).style.display='none'; }
    updateDropdowns();
</script>
</body>
</html>
